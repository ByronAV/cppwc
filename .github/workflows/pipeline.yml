name: Format, Build and Test


on:
    push:
        branches:
            - main

jobs:
    format-check:
        name: Formatting Check
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Install clang-format
              run: sudo apt-get install clang-format

            - name: Run clang-format
              run: |
                clang-format --version
                find . -name "*.cpp" -o -name "*.h" | xargs clang-format -i
                git diff --exit-code
              continue-on-error: true # Don't stop the pipeline on error
            
            - name: Report formatting issues
              if: failure() # Show warning if formatting is not correct
              run: echo "WARNING Code formatting issues detected."
    
    build:
        name: Build Project
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Install dependencies
              run: sudo apt-get update && sudo apt-get install -y build-essential cmake
              
            - name: Build project with CMake
              run: |
                mkdir -p build
                cd build
                cmake ..
                make

    test:
        name: Run Tests
        runs-on: ubuntu-latest
        needs: build
        steps:
          - name: Checkout code
            uses: actions/checkout@v4

          - name: Build for test
            run: |
              cd build
              cmake -DBUILD_TESTING=ON ..
              make
              ./cppwc_test
